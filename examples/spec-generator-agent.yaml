version: 0
name: spec-generator-agent
description: |
  Advanced workflow specification generator with MVP compliance verification.
  
  **Three-Agent Architecture**:
  1. **Architect**: Generates initial spec from requirements
  2. **Validator**: Uses spec_verify tool + RESIDUAL.md knowledge to check compliance  
  3. **Documenter**: Creates comprehensive usage documentation
  
  **Features**:
  - Schema/Pydantic/capability tri-level validation
  - RESIDUAL.md feature restriction enforcement (12 unsupported, 14 parsed-only, 5 partial)
  - Iterative refinement with spec_verify tool feedback
  - Production-ready, immediately runnable workflow generation

runtime:
  provider: openai
  model_id: gpt-5
  budgets:
    max_tokens: 150000
  failure_policy:
    retries: 3
    backoff: exponential

inputs:
  values:
    use_case: "customer support routing workflow"
    provider: "openai"
    model: "gpt-5-nano"
    num_agents: 2
    pattern_type: "chain"
    include_tools: false

context_policy:
  compaction:
    enabled: true
    when_tokens_over: 30000
    summary_ratio: 0.3
    preserve_recent_messages: 6
  notes:
    file: ./spec-generation-notes.md
    include_last: 4

tools:
  python:
    - spec_verify

agents:
  spec_architect:
    model_id: gpt-5
    prompt: |
      You are an expert Strands workflow specification architect with deep knowledge of
      the schema, all 7 patterns, and MVP implementation constraints.
      
      # CRITICAL MVP CONSTRAINTS
      
      **üî¥ COMPLETELY UNSUPPORTED** (Will break or be ignored):
      - `runtime.budgets.max_steps` - Logged only, NOT enforced
      - `runtime.budgets.max_duration_s` - Logged only, NOT enforced  
      - `env.secrets[].source: secrets_manager|ssm|file` - Only `env` works (triggers EX_UNSUPPORTED)
      - `env.mounts` - No file mounting
      - `security.guardrails.*` - All fields ignored
      - `agents.{id}.provider` - Per-agent provider override ignored
      - `orchestrator.limits.max_rounds > 1` - Single-round only (triggers EX_UNSUPPORTED)
      - `inputs.{var}.type` - Type validation not enforced
      - `inputs.{var}.default` - Defaults not applied
      
      **‚ö†Ô∏è PARSED BUT NOT ENFORCED** (Silently ignored):
      - `runtime.failure_policy.wait_min/wait_max` - Hardcoded 2-30s
      - `agents.{id}.inference` - Only works for OpenAI provider
      - `context_policy.notes.format: json` - Only markdown works
      - `tools.http_executors[].description/examples` - Not shown to agents
      - HITL `default`, `timeout_seconds`, `validation.pattern` - Not enforced
      
      **üü° PARTIALLY IMPLEMENTED** (Works with limitations):
      - `runtime.budgets.max_tokens` - Enforced AFTER compaction (set conservative values)
      - `graph.edges[].to: [multiple]` - Only first target executes
      - MCP tools - Startup timeout not enforced
      
      # PATTERN EXAMPLES
      
      ## Chain Pattern
      ```yaml
      version: 0
      name: content-workflow
      runtime:
        provider: openai
        model_id: gpt-5-nano
        budgets:
          max_tokens: 50000  # Only enforced budget
      
      agents:
        writer:
          prompt: "You write content"
        editor:
          prompt: "You edit for clarity"
      
      pattern:
        type: chain
        config:
          steps:
            - agent: writer
              input: "Write about {{ topic }}"
            - agent: editor
              input: "Edit: {{ steps[0].response }}"
      
      inputs:
        values:
          topic: "AI ethics"
      
      outputs:
        artifacts:
          - path: "./output.md"
            from: "{{ last_response }}"
      ```
      
      ## Workflow Pattern (DAG)
      ```yaml
      pattern:
        type: workflow
        config:
          tasks:
            - id: research
              agent: researcher
              input: "Research {{ topic }}"
            - id: analyze
              agent: analyst
              deps: [research]
              input: "Analyze: {{ tasks.research.response }}"
            - id: summarize
              agent: writer
              deps: [analyze]
              input: "Summarize: {{ tasks.analyze.response }}"
      ```
      
      ## Routing Pattern
      ```yaml
      pattern:
        type: routing
        config:
          user_input: "{{ query }}"
          routes:
            - agent: technical_support
              condition: "Technical issues or bugs"
            - agent: billing_support
              condition: "Billing or payment questions"
            - agent: general_support
              condition: "Everything else"
      ```
      
      ## Parallel Pattern
      ```yaml
      pattern:
        type: parallel
        config:
          branches:
            - id: technical
              agent: researcher
              input: "Research technical {{ topic }}"
            - id: business
              agent: researcher
              input: "Research business {{ topic }}"
          reduce:
            agent: synthesizer
            input: |
              Technical: {{ branches.technical.response }}
              Business: {{ branches.business.response }}
              Synthesize findings.
      ```
      
      ## Evaluator-Optimizer Pattern
      ```yaml
      pattern:
        type: evaluator_optimizer
        config:
          producer: writer
          evaluator:
            agent: reviewer
            input: |
              Review: {{ draft }}
              Return JSON: {"score": 0-100, "issues": [...], "fixes": [...]}
          accept:
            min_score: 85
            max_iters: 4
          revise_prompt: |
            Score: {{ evaluation.score }}/100
            Issues: {% for issue in evaluation.issues %}{{ issue }}{% endfor %}
            Revise the draft.
      ```
      
      ## Orchestrator-Workers Pattern
      ```yaml
      pattern:
        type: orchestrator_workers
        config:
          orchestrator:
            agent: planner
            input: "Break down: {{ task }}"
            limits:
              max_rounds: 1  # MVP: only 1 supported
              max_workers: 5
          worker:
            agent: executor
          reduce:
            agent: aggregator
            input: "Synthesize: {{ worker_results }}"
      ```
      
      ## Graph Pattern
      ```yaml
      pattern:
        type: graph
        config:
          start: "analyze"
          nodes:
            - id: analyze
              agent: analyzer
              input: "Analyze {{ request }}"
            - id: approve
              agent: approver
              input: "Auto-approved"
            - id: review
              agent: reviewer
              input: "Manual review"
          edges:
            - from: analyze
              choose:
                model_id: gpt-5-nano
                options:
                  - label: low_risk
                    to: approve
                    condition: "Low risk detected"
                  - label: high_risk
                    to: review
                    condition: "High risk detected"
            - from: approve
              to: [notify]  # Only first target executes
            - from: review
              to: [notify]
      ```
      
      # YOUR GENERATION PROCESS
      
      1. **Analyze Requirements**: Understand use case and pattern fit
      2. **Select Pattern**: Choose most appropriate pattern
      3. **Design Agents**: Create specialized agent prompts
      4. **Apply Constraints**: Use ONLY MVP-supported features
      5. **Validate**: Use spec_verify tool to check
      6. **Output YAML**: Raw YAML only (no markdown fences)
      
      Generate valid, MVP-compliant specs!

  spec_validator:
    model_id: gpt-5
    prompt: |
      You are a workflow specification validator. You verify specs against:
      1. JSON Schema Draft 2020-12
      2. Pydantic model validation
      3. MVP capability compatibility (RESIDUAL.md)
      
      Use the spec_verify tool to get detailed validation reports.
      
      **Validation Report Structure**:
      ```json
      {
        "schema_valid": bool,
        "pydantic_valid": bool,
        "capability_supported": bool,
        "errors": [{phase, type, message, validation_errors}],
        "issues": [{pointer, reason, remediation}]
      }
      ```
      
      **MVP Compliance Checks**:
      - Secret sources must be `env` only
      - Orchestrator max_rounds must be 1 or omitted
      - No security.guardrails usage
      - No env.mounts usage
      - Tools must be from allowlist
      - No per-agent provider overrides
      
      **Your Process**:
      1. Receive spec content
      2. Run spec_verify tool with check_capability: true
      3. Analyze validation report
      4. If all valid: return "VALID" with summary
      5. If errors: return detailed fixes needed
      
      Be thorough and precise!

  documentation_writer:
    model_id: gpt-5
    prompt: |
      You write comprehensive documentation for workflow specifications.
      
      **Documentation Structure**:
      1. Overview - What the workflow does
      2. Architecture - Pattern type and agent roles
      3. Usage Instructions - How to run with examples
      4. Configuration - Available input variables
      5. Expected Outputs - What artifacts are generated
      6. Customization - How to modify for different needs
      
      Write clear, actionable documentation in markdown.

pattern:
  type: chain
  config:
    steps:
      - agent: spec_architect
        input: |
          Generate a Strands workflow specification:
          
          **Use Case**: {{ use_case }}
          **Provider**: {{ provider }}
          **Model**: {{ model }}
          **Number of Agents**: {{ num_agents }}
          **Pattern Type**: {{ pattern_type }}
          **Include Tools**: {{ include_tools }}
          
          CRITICAL INSTRUCTIONS:
          1. Study the pattern examples carefully
          2. Use ONLY MVP-supported features (check constraints section)
          3. Validate with spec_verify tool before outputting
          4. If validation fails, fix errors and re-validate
          5. Output ONLY raw YAML (no markdown code fences)
          
          The spec must be schema-valid, pydantic-valid, and capability-supported.
        tool_overrides:
          - spec_verify
      
      - agent: spec_validator
        input: |
          Validate this generated specification for MVP compliance:
          
          ```yaml
          {{ steps[0].response }}
          ```
          
          VALIDATION STEPS:
          1. Use spec_verify tool with check_capability: true
          2. Check for unsupported features from RESIDUAL.md
          3. Verify pattern structure matches schema
          4. Confirm all agent references exist
          
          Return validation result:
          - If VALID: "VALIDATION PASSED - All checks successful"
          - If INVALID: List all issues with remediations
        tool_overrides:
          - spec_verify
      
      - agent: spec_architect
        input: |
          Previous validation result:
          {{ steps[1].response }}
          
          {% if "PASSED" in steps[1].response %}
          The spec is valid! Output it unchanged:
          {{ steps[0].response }}
          {% else %}
          The spec has validation errors. Fix them and output corrected YAML.
          
          Original spec:
          {{ steps[0].response }}
          
          Validation feedback:
          {{ steps[1].response }}
          
          Apply all fixes and output ONLY the corrected raw YAML.
          {% endif %}
        tool_overrides:
          - spec_verify
      
      - agent: documentation_writer
        input: |
          Create comprehensive documentation for this workflow specification:
          
          ```yaml
          {{ steps[2].response }}
          ```
          
          **Documentation Requirements**:
          1. Overview section explaining the workflow purpose
          2. Architecture section describing the pattern and agents
          3. Usage section with example CLI commands
          4. Configuration section listing input variables
          5. Outputs section describing artifacts
          6. Customization section with modification tips
          
          Format as clear, structured markdown.

outputs:
  artifacts:
    - path: ./generated-workflow.yaml
      from: "{{ steps[2].response }}"
    
    - path: ./workflow-documentation.md
      from: "{{ steps[3].response }}"
    
    - path: ./validation-report.md
      from: |
        # Workflow Generation Report
        
        **Use Case**: {{ use_case }}
        **Pattern**: {{ pattern_type }}
        **Provider**: {{ provider }}
        
        ## Validation Status
        
        {{ steps[1].response }}
        
        ## Generated Specification
        
        See `generated-workflow.yaml`
        
        ## Documentation
        
        See `workflow-documentation.md`
