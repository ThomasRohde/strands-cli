version: 1
name: deep-research-agent
description: |
  Multi-stage deep research agent that conducts comprehensive research on any topic.
  Uses DuckDuckGo search for web content, news, and cross-validation.
  Run with: strands run duckduckgo-search-demo.yaml --ask

runtime:
  provider: openai
  model_id: gpt-5

context_policy:
  notes:
    file: "./artifacts/deep-research-notes.md"
    include_last: 12
    format: "markdown"
  
agents:
  initial_researcher:
    prompt: |
      You are an expert research analyst conducting preliminary research.
      
      Your goal is to identify the key themes, questions, and areas to explore
      for the given topic. Use DuckDuckGo search to gather initial information,
      then call the web_fetch tool in markdown mode on the most relevant URLs
      to capture full-page context without excess tokens.
      
      The duckduckgo_search tool returns JSON with:
      - title: Page title
      - href: URL
      - body: Content snippet
      The web_fetch tool retrieves the full content for each URL so you can
      extract detailed evidence.
      
      Search broadly first, then identify:
      1. Main subtopics and concepts
      2. Key questions to investigate
      3. Recent developments or controversies
      4. Important sources and experts
      
      Maintain shared research notes using the 'notes' tool:
      - Before each search, review injected notes + "Previous Workflow Steps" to avoid duplicates.
      - After each promising source, append a short heading with supporting bullets and cite URLs.
      
      Provide a structured research plan.

  deep_researcher:
    prompt: |
      You are a deep research specialist who investigates specific aspects thoroughly.
      
      Use DuckDuckGo search to dive deep into subtopics and answer specific questions.
      For every promising result, immediately fetch the referenced page with
      web_fetch (mode="markdown") to read detailed explanations, quotes, and data.
      Cross-reference multiple sources and look for:
      - Supporting evidence
      - Contradictory viewpoints
      - Technical details
      - Real-world applications
      
      Leverage the shared notes workspace:
      - Review existing entries before tackling each subtopic.
      - Record every decisive finding, metric, and counterpoint with citations so later agents can reference them.
      
      Synthesize findings with critical analysis. Always cite sources with URLs.

  news_analyst:
    prompt: |
      You are a news and trends analyst tracking recent developments.
      
      Use DuckDuckGo news search (search_type="news") to find:
      - Latest news and announcements
      - Industry trends
      - Expert commentary
      - Recent studies or reports
      
      For news searches, results include:
      - date: Publication date
      - source: News source name
      
      Focus on developments from the past month (timelimit="m").
      After selecting relevant hits, fetch the underlying article URLs via
      web_fetch (mode="markdown") to confirm facts and capture quotes.
      Highlight breaking news and emerging trends.
      
      Use the shared notes (notes tool) to log each headline with:
      - Publication date + source
      - 1-2 sentence summary
      - Key quote or statistic for later verification.

  synthesis_expert:
    prompt: |
      You are a research synthesis expert who creates comprehensive reports.
      
      Analyze all previous research findings and create a well-structured,
      authoritative report that:
      1. Summarizes key findings with clear headings
      2. Integrates web research and news analysis
      3. Presents balanced perspectives
      4. Highlights important sources
      5. Identifies knowledge gaps and future directions
      
      Before writing, review the shared notes injected into your context so the report references prior insights accurately and credits original sources.
      
      Write in clear, professional language suitable for educated readers.

  fact_checker:
    prompt: |
      You are a fact-checking specialist ensuring research accuracy.
      
      Review the synthesized report and verify key claims by:
      1. Cross-referencing with additional searches
      2. Fetching cited sources with web_fetch (mode="markdown") to confirm wording
      3. Checking source credibility
      4. Identifying unsupported assertions
      5. Flagging potential biases
      
      Update the shared notes with confirmations, corrections, and outstanding questions so future iterations inherit the audit trail.
      
      Provide specific corrections or confirmations with evidence.

# Interactive variable prompting - run with --ask flag
inputs:
  required:
    topic:
      type: string
      description: "Research topic or question to investigate deeply"
    
    depth:
      type: string
      description: "Research depth level"
      enum: ["quick", "standard", "comprehensive"]
      
    max_sources:
      type: integer
      description: "Maximum sources per search (3-10 recommended)"

pattern:
  type: chain
  config:
    steps:
      # Stage 1: Initial reconnaissance
      - agent: initial_researcher
        input: |
          Conduct preliminary research on: {{ topic }}
          
          Research depth: {{ depth }}
          
          Use DuckDuckGo search with max_results={{ max_sources }} to explore:
          1. Main concepts and definitions
          2. Current state of the field
          3. Key subtopics to investigate
          
          Create a structured research plan identifying 3-5 specific areas to explore.
          
          For at least two priority sources, call web_fetch (mode="markdown") using
          the returned href values to capture detailed context you can cite later.
          
          Log each identified subtopic and leading sources to the shared notes file
          (use the 'notes' tool with headings + bullet evidence).

      # Stage 2: Deep dive into subtopics
      - agent: deep_researcher
        input: |
          Based on this research plan:
          
          {{ steps[0].response }}
          
          Conduct deep research on the identified subtopics for: {{ topic }}
          
          For each subtopic:
          1. Search for detailed information (max_results={{ max_sources }})
          2. Fetch at least two authoritative URLs with web_fetch (mode="markdown") to review full content
          3. Look for technical details and expert analysis
          4. Find supporting evidence and examples
          5. Note any controversies or alternative views
          
          Before diving into each subtopic, review the last few notes so you build on prior context.
          After finishing a subtopic, append a new notes entry summarizing critical evidence, conflicting views, and citations.
          
          Synthesize comprehensive findings for each area.

      # Stage 3: News and trends analysis
      - agent: news_analyst
        input: |
          Analyze recent news and developments related to: {{ topic }}
          
          Use news search (search_type="news", timelimit="m") to find:
          1. Latest announcements and breakthroughs
          2. Industry trends and expert commentary
          3. Recent studies or reports
          
          Maximum {{ max_sources }} news items.
          
          Fetch each selected article URL via web_fetch (mode="markdown", timeout=20)
          so you can cite concrete quotes or data points.
          
          Capture each headline in the shared notes with date, source, gist, and citation
          so downstream agents can trace developments chronologically.
          
          How do recent developments relate to the earlier research?
          
          Previous research context:
          {{ steps[0].response | truncate(500) }}

      # Stage 4: Synthesis and integration
      - agent: synthesis_expert
        input: |
          Create a comprehensive research report on: {{ topic }}
          
          Research depth: {{ depth }}
          
          Integrate these research phases:
          
          INITIAL RESEARCH:
          {{ steps[0].response }}
          
          DEEP ANALYSIS:
          {{ steps[1].response }}
          
          NEWS & TRENDS:
          {{ steps[2].response }}
          
          Structure the report with:
          1. Executive Summary
          2. Background and Context
          3. Key Findings (organized by theme)
          4. Recent Developments and Trends
          5. Implications and Future Directions
          6. References (with URLs)

      # Stage 5: Fact-checking and validation
      - agent: fact_checker
        input: |
          Review this research report for accuracy and completeness:
          
          {{ steps[3].response }}
          
          For topic: {{ topic }}
          
          Verify key claims by conducting targeted searches (max_results=3).
          Check for:
          1. Factual accuracy of major claims
          2. Source credibility
          3. Fetching critical references with web_fetch (mode="markdown") to confirm quotes
          4. Missing perspectives
          5. Potential biases
          
          Document each correction, confirmation, or open question in the shared notes
          so future runs inherit the audit trail.
          
          Provide corrections, confirmations, or additional context.

tools:
  python:
    - duckduckgo_search  # Native DuckDuckGo search tool with text and news search
    - web_fetch  # Fetch full pages in HTML or markdown for deeper analysis

outputs:
  artifacts:
    - path: "./research-report.md"
      from: |
        # Deep Research Report: {{ topic }}
        
        **Research Depth:** {{ depth }}  
        **Sources per Search:** {{ max_sources }}
        
        ---
        
        ## Final Report
        
        {{ steps[3].response }}
        
        ---
        
        ## Fact-Check and Validation
        
        {{ steps[4].response }}
        
        ---
        
        ## Research Methodology
        
        This report was generated through a 5-stage research process:
        1. **Initial Reconnaissance** - Broad search to identify key themes
        2. **Deep Analysis** - Detailed investigation of subtopics
        3. **News Analysis** - Recent developments and trends
        4. **Synthesis** - Integration into comprehensive report
        5. **Fact-Checking** - Validation and verification
        
        All findings sourced from DuckDuckGo web/news searches with full-page
        retrieval via the web_fetch tool (markdown mode) and documented in the
        shared notes file at ./artifacts/deep-research-notes.md for continuity.
